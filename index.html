<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Modelleertaal webapp</title>

	<style>
    html {
		font-family: Helvetica, Arial, sans-serif;
		font-size: 100%;
    }
		table {
      border: 1px solid black;
	  }
		th, td {
      border: 1px solid black;
		  padding: 5px;
		}
    /* schaduw rand om werkblad zodat afmetinging zichtbaar is
       handig voor debuggen */
    #werkBlad {
		padding: 1em;
		margin: 1em auto;
		box-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }
	#graph {
		  width: 450px;
	    height: 300px;
	}
    </style>
    <script src="jquery-3.2.1.js"></script>
  	<script src="jquery.flot.js"></script>
		<script src="jquery.flot.axislabels.js"></script>
		<script src="FileSaver.min.js"></script>
		<script src="Blob.js"></script>
</head>


<body>
	<div id="werkBlad"> <!-- CSS zorg voor met werkvlak met schaduw -->
        <h2>Modelleertaal</h2>
        <div>
			<input type="file" id="fileinput">
			<input id="download" type="button" value= "Download model.xml">
		</div>
		<p>
		<div>
			<input id="open" type="button" value= "Laad model:">
			<select id="model_keuze">
		    <option value="0">Examen vwo 2005-I Champignon</option>
		    <option value="1">Examen vwo 2016-I Ruimtelift</option>
		    <option value="2">Opgave 17 Satelliet</option>
			</select>
	  </div>
		<p>
		<div>
			<textarea id="modelregels"  rows=15 cols=40> Modelregels </textarea>
			<textarea id="startwaarden" rows=15 cols=25> Startwaarden </textarea>
			<p>
			<input id="run" type="button" value= "RUN!">
			Aantal iteraties = <input type="text" id="NBox" value="1000" size=5>
			<span id="output"></span>
		</div>

		<p>

		<div id="graph" class="graph">Model niet geladen!</div>
		<p>
		verticaal: <input type="text" id="y_var" size=3>
		horizontaal: <input type="text" id="x_var" size=3>
		<input id="plot" type="button" value= "Plot!">
		<p>Aflezen: <span id="hoverdata"></span><span id="clickdata"></span></p>
	</div>

	<div id="werkBlad">
		<pre id="status">Status: OK</pre>
	</div>

	<div id="werkBlad">
		<pre id="datatable">Hier komt een tabel...</pre>
	</div>



	<!-- script/modules created with:
	     browserify SCRIPT.js -d -s SCRIPT_js -o /dist/SCRIPT_browserfied.js
		 access functions using SCRIPT_js object
	-->
	<script src="dist/evaluator.browser.js"></script>

	<script type="text/javascript">

		//  global datasets
		var results = [];			// array of results
		var allVars = [];			// array of names of vars in results array

		var previous_plot = [];		// dataset of previous plot

		function readSingleFile(evt) {
			var f = evt.target.files[0];

			if (f) {
				var r = new FileReader();
				r.onload = function(e) {
					var data = e.target.result;
			model.parseBogusXMLString(data);
			$("#modelregels").val(model.modelregels);
			$("#startwaarden").val(model.startwaarden);
				}
				r.readAsText(f);
			}
		}

		document.getElementById('fileinput').addEventListener('change', readSingleFile, false);

	$(document).ready(function() {

			$("#run").click(function() {
				console.log('RUN! clicked.');

				// read model from textarea
				model = new evaluator_js.Model();
				model.modelregels = $("#modelregels").val();
				model.startwaarden = $("#startwaarden").val();
				console.log('model = ', model);

				// read N from input field
				var N = Number($('#NBox').val());

				if (N > 1e6) {
					alert('N too big!');
					throw new Error('N too big!');
				}

				//run!
				var output_str = "Run started..."
				$("#output").html(output_str);
				console.log(output_str);
				try {
					var evaluator = new evaluator_js.ModelregelsEvaluator(model, true);
			 	} catch(err) {
					$("#graph").html(err.message.replace(/\n/g,"<br>"));
					$("#status").html("Status: ERROR.");
					alert("Model niet in orde: \n"+err.message);
			 	}
				results = evaluator.run(N);
				var output_str = "Klaar na iteratie: " + results.length
				$("#output").html(output_str);
				$("#status").html("Status: RUN OK.")
				console.log(output_str);

				// make table, plot
				allVars = evaluator.namespace.listAllVars();
				console.log(allVars, allVars.length);
				print_table("#datatable", results, allVars)
				do_plot("#graph", results, allVars);

			}); // run()

			$("#plot").click(function() {
				do_plot("#graph", results, allVars);
				$("#status").html("Status: Plot OK.")
			});

			function do_plot(placeholder, results, allVars) {
					var scatter_plot = [];

					// get column indices (in results array) of variables to plot
					xvar_colidx = get_column_index($('#x_var').val(), allVars, 0);
					yvar_colidx = get_column_index($('#y_var').val(), allVars, 1);

					// set column varnames in input fields
					$('#x_var').val(allVars[xvar_colidx])
					$('#y_var').val(allVars[yvar_colidx])

					Nresults = Math.min(results.length, 100);
					results = reduce_rows(results, Nresults);
					console.log(results.length);

					for (var i=0; i < results.length; i++) {
							scatter_plot.push([results[i][xvar_colidx], results[i][yvar_colidx]]);
					}
					$(placeholder).empty(); // verwijder text enzo
					plot_graph(placeholder, scatter_plot);
					previous_plot = scatter_plot;
			}; // do_plot

			function plot_graph(placeholder, dataset) {
				$.plot($(placeholder), [
							{data: previous_plot, color: '#d3d3d3'},
							{data: dataset, color: 'blue'}],
						  {
										series: {
											  lines: {
														show: true
												},
												points: {
														radius: 1,
														show: true,
														fill: true,
												},
										},
										grid: {
											hoverable: true,
											clickable: true
										},
										axisLabels: {
            				show: true
        						},
						        xaxes: [{
						            axisLabel: $('#x_var').val(),
						        }],
        						yaxes: [{
						            position: 'left',
						            axisLabel: $('#y_var').val(),
        						}],
				}); // $.plot()

				$(placeholder).bind("plothover", function (event, pos, item) {
					var str = "(" + pos.x.toFixed(2) + ", " + pos.y.toFixed(2) + ")";
					$("#hoverdata").text(str);
				}); // $.bind("plothover")

				$(placeholder).bind("plotclick", function (event, pos, item) {
					if (item) {
						var str = " - Click: (" + pos.x.toFixed(2) + ", " +
						   pos.y.toFixed(2) + ")";
						$("#clickdata").text(str);
					}
				}); // $bind.("plotclick")

			} // plot_graph()


			function print_table(placeholder, dataset, varnames) {

				var firstrow = $('<tr>')
				var table = $('<table>').addClass('table');;
				firstrow.append($('<th>').text('#'));

				for (var k = 0; k < varnames.length; k++) {
					firstrow.append($('<th>').text(varnames[k]));
				}
				table.append(firstrow);

				// reduce to max 500 rows to prevent browser lockup
				Nresults = Math.min(dataset.length, 500);
				dataset = reduce_rows(dataset, Nresults);

				for (var i = 0; i < dataset.length; i++) {
									var row = $('<tr>');
									row.append($('<td>').text(i));
									for (var j = 0; j < dataset[i].length; j++) {
											row.append($('<td>').text(dataset[i][j].toFixed(3)));}
									table.append(row);
				}
				$(placeholder).html(table);
			}

			function get_column_index(field_value, varslist, default_value) {
				if (field_value) {
					console.log("DEBUG: ")
					console.log(varslist);
					var idx = varslist.findIndex(x =>  x == field_value);
					if (idx == -1) {
						alert("Variable voor grafiekas niet gevonden: "+field_value);
						return default_value;
					} else return idx;
				} else return default_value;
			}

			function reduce_rows(rows, Nresults) {
					// reduce resultsObject (large array) to length == Nresults

					var length = rows.length;
			    var rowinc = Math.floor(length / Nresults);

			    function select_rows(value, index) {
			        // select first row, last row and rows in between. Keep Nrows+1 rows.
			        if (index === 0 || index % rowinc === 0 || index == length-1) {
			            return true;
			        } else {
			            return false;
			        }
			    }

			    if (length > Nresults) {
			        return rows.filter(select_rows);
			    }
			    return rows;
			}
	});



$(document).ready(function() {
// read model
$.ajax({
url : "modellen/examenvwo2005.xml",
dataType: "text",
success : function (data) {
	model = new evaluator_js.Model();
	model.parseBogusXMLString(data);
	$("#modelregels").val(model.modelregels);
	$("#startwaarden").val(model.startwaarden);
	$("#x_var").val("");
	$("#y_var").val("");
	}
});
$("#graph").html("Model geladen. Geen data. Druk op Run!");
$("#output").empty()
});

// read model after button press
$("#open").click(function() {

		// lees keuze uit drop-down en kies juiste url
		// Dit moet beter: niet hard coded... sometime.
		model_keuze = $("#model_keuze").val();
		urls = ['modellen/examenvwo2005.xml',
						'modellen/examenvwo2016.xml',
						'modellen/satelliet.xml']
					$.ajax({
							url : urls[model_keuze],
							dataType: "text",
							success : function (data) {
									model = new evaluator_js.Model();
		model.parseBogusXMLString(data);
		$("#modelregels").val(model.modelregels);
		$("#startwaarden").val(model.startwaarden);
		$("#x_var").val("");
		$("#y_var").val("");
									}
							});
		$("#graph").html("Model geladen. Geen data. Druk op Run!");
		$("#output").empty()
			});

$("#download").click(function() {
		// requires FileSaver.js and Blob.js
		// (Blob() not supported on most mobile browsers)
		console.log("Download model.xml!");
		model = new evaluator_js.Model();
		model.modelregels = $("#modelregels").val();
		model.startwaarden = $("#startwaarden").val();

		var blob = new Blob([model.createBogusXMLString()], {type: "text/plain;charset=utf-8"});
		saveAs(blob, "model.xml");
});

</script>


</body>
</html>
